!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("persistentwebsocket",[],t):"object"==typeof exports?exports.persistentwebsocket=t():e.persistentwebsocket=t()}(this,function(){return function(e){function t(i){if(n[i])return n[i].exports;var o=n[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1)}([function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){return Math.floor(Math.random()*(t-e))+e}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),c=function(){function e(t,n){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o;i(this,e),this._initialDelay=t,this._maxDelay=n,this._nextDelay=this._initialDelay,this._randomBetween=s}return s(e,[{key:"reset",value:function(){this._nextDelay=this._initialDelay}},{key:"nextDelay",value:function(){var e=this._nextDelay;return this._nextDelay=Math.min(this._maxDelay,this._randomBetween(this._initialDelay,3*e)),e}}]),e}();t.default=c,e.exports=t.default},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(){}Object.defineProperty(t,"__esModule",{value:!0}),t.PersistentWebsocket=t.AttemptReconnectEvent=t.defaultOptions=t.READYSTATE=void 0;var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),a=n(0),u=i(a),l=t.READYSTATE={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3},h=t.defaultOptions={debug:!1,initialBackoffDelayMillis:500,maxBackoffDelayMillis:12e4,pingSendFunction:null,pingIntervalSeconds:30,pingTimeoutMillis:2e3,connectTimeoutMillis:3e3,reachabilityTestUrl:null,reachabilityTestTimeoutMillis:2e3,reachabilityPollingIntervalMillis:3e3,xhrConstructor:null,websocketConstructor:null},_=t.AttemptReconnectEvent=function e(t,n){o(this,e),this.attemptNumber=t,this.waitMillis=n};t.PersistentWebsocket=function(){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};o(this,e),"object"===("undefined"==typeof n?"undefined":c(n))&&(i=n,n=void 0),this.onopen=s,this.onclose=s,this.onmessage=s,this.onerror=s,this.onbeforereconnect=s,this._handlers={open:[],close:[],message:[],error:[],beforereconnect:[]},this._url=t,this._protocols=n,this._options=Object.assign({},h,i),this._backoff=new u.default(this._options.initialBackoffDelayMillis,this._options.maxBackoffDelayMillis),this._waitingForPong=!1,this._manuallyClosed=!1,this._hasConnected=!1,this._retryCount=0,this._pingTimeoutId=0,this._scheduledReconnectTimeoutId=0,this._websocketConnectionCheckTimeoutId=0,this._reachabilityCheckTimeoutId=0,this._websocketConstructor=this._options.websocketConstructor||WebSocket,this._xhrConstructor=this._options.xhrConstructor||XMLHttpRequest}return r(e,[{key:"_openWebsocket",value:function(){this._debugLog("Trying to open websocket");var e=new this._websocketConstructor(this._url,this._protocols);this._binaryType&&(e.binaryType=this._binaryType),e.onclose=this._onWebsocketClose.bind(this),e.onerror=this._onWebsocketError.bind(this),e.onmessage=this._onWebsocketMessage.bind(this),e.onopen=this._onWebsocketOpen.bind(this),this._websocket=e,this._scheduleWebsocketConnectionCheck()}},{key:"_callHandlers",value:function(e,t){this._handlers[e]&&this._handlers[e].forEach(function(e){return e(t)})}},{key:"_onWebsocketClose",value:function(e){e.wasExpected=this._manuallyClosed,this.onclose(e),this._callHandlers("close",e),this._manuallyClosed||this._checkReachabilityAndScheduleReconnect()}},{key:"_onWebsocketError",value:function(e){this.onerror(e),this._callHandlers("error",e)}},{key:"_onWebsocketMessage",value:function(e){this._waitingForPong=!1,this._schedulePing(),this.onmessage(e),this._callHandlers("message",e)}},{key:"_onWebsocketOpen",value:function(e){e.wasReconnect=this._hasConnected,this.onopen(e),this._callHandlers("open",e),this._hasConnected=!0,this._retryCount=0,e.target.readyState==l.OPEN&&(this._schedulePing(),this._cancelWebsocketConnectionCheck())}},{key:"_sendPing",value:function(){this._debugLog("Pinging websocket..."),this._waitingForPong=!0,this._options.pingSendFunction(this),setTimeout(this._checkPingResult.bind(this),this._options.pingTimeoutMillis)}},{key:"_schedulePing",value:function(){this._pingTimeoutId&&this._cancelPing();var e=this._options,t=e.pingSendFunction,n=e.pingIntervalSeconds;t&&n&&(this._pingTimeoutId=setTimeout(this._sendPing.bind(this),1e3*n))}},{key:"_cancelPing",value:function(){clearTimeout(this._pingTimeoutId),this._pingTimeoutId=0}},{key:"_checkPingResult",value:function(){this._waitingForPong&&(this._debugLog("Closing websocket due to ping failure."),this._websocket.close(4001,"Closing websocket due to ping failure."))}},{key:"_checkReachabilityAndScheduleReconnect",value:function(){var e=this;if(this._options.reachabilityTestUrl){var t=new this._xhrConstructor;t.open("HEAD",this._options.reachabilityTestUrl),t.timeout=this._options.reachabilityTestTimeoutMillis,t.onload=function(){e._reachabilityCheckTimeoutId=0,e._debugLog("ONLINE: HEAD request to "+e._options.reachabilityTestUrl+" succeeded."),e._scheduleReconnect()};var n=function(){e._debugLog("OFFLINE: Unable to reach "+e._options.reachabilityTestUrl+".\nTrying again in 3s."),e._backoff.reset(),e._reachabilityCheckTimeoutId=setTimeout(e._checkReachabilityAndScheduleReconnect.bind(e),e._options.reachabilityPollingIntervalMillis)};t.onerror=n,t.ontimeout=n,t.send()}else this._scheduleReconnect()}},{key:"_cancelReachabilityCheck",value:function(){this._reachabilityCheckTimeoutId&&(clearTimeout(this._reachabilityCheckTimeoutId),this._reachabilityCheckTimeoutId=0)}},{key:"_scheduleReconnect",value:function(){var e=this._backoff.nextDelay();this._retryCount++,this._debugLog("Scheduling websocket reconnect attempt "+this._retryCount+" in "+e+"ms");var t=new _(this._retryCount,e);this.onbeforereconnect(t),this._callHandlers("beforereconnect",t),this._scheduledReconnectTimeoutId=setTimeout(this._openWebsocket.bind(this),e)}},{key:"_cancelScheduledReconnect",value:function(){this._scheduledReconnectTimeoutId&&(clearTimeout(this._scheduledReconnectTimeoutId),this._scheduledReconnectTimeoutId=0)}},{key:"_scheduleWebsocketConnectionCheck",value:function(){setTimeout(this._checkWebsocketConnection.bind(this),this._options.connectTimeoutMillis)}},{key:"_cancelWebsocketConnectionCheck",value:function(){this._websocketConnectionCheckTimeoutId&&(clearTimeout(this._websocketConnectionCheckTimeoutId),this._websocketConnectionCheckTimeoutId=0)}},{key:"_checkWebsocketConnection",value:function(){this._debugLog("Checking websocket connection. ReadyState is "+this._websocket.readyState),this._websocket.readyState===l.OPEN?this._schedulePing():this._websocket.close(4e3,"Unable to establish websocket connection before the configured connectTimeoutMillis")}},{key:"_debugLog",value:function(e){this._options.debug&&console.debug(e)}},{key:"open",value:function(){if(this._websocket)throw"Websocket has already been opened";this._openWebsocket()}},{key:"close",value:function(e,t){if(this._manuallyClosed=!0,this._cancelScheduledReconnect(),this._cancelWebsocketConnectionCheck(),this._cancelReachabilityCheck(),this._cancelPing(),!this._websocket)throw"Can't close websocket because it was never opened.";this._websocket.close(e,t)}},{key:"send",value:function(e){if(!this._websocket)throw"Can't send through websocket because it was never opened.";this._websocket.send(e)}},{key:"addEventListener",value:function(e,t){this._handlers.hasOwnProperty(e)&&this._handlers[e].push(t)}},{key:"removeEventListener",value:function(e,t){if(this._handlers[e])if(t){var n=this._handlers[e].indexOf(t);n>-1&&this._handlers[e].splice(n,1)}else this._handlers[e]=[]}},{key:"readyState",get:function(){if(!this._websocket)throw"Can't get websocket readyState because it was never opened.";return this._websocket.readyState}},{key:"url",get:function(){return this._url}},{key:"bufferedAmount",get:function(){if(!this._websocket)throw"Can't get websocket bufferedAmount because it was never opened.";return this._websocket.bufferedAmount}},{key:"extensions",get:function(){if(!this._websocket)throw"Can't get websocket extensions because it was never opened.";return this._websocket.extensions}},{key:"binaryType",get:function(){return this._binaryType},set:function(e){this._binaryType=e,this._websocket&&(this._websocket.binaryType=e)}},{key:"retryCount",get:function(){return this._retryCount}}]),e}()}])});