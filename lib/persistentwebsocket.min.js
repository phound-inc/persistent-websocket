!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("persistentwebsocket",[],t):"object"==typeof exports?exports.persistentwebsocket=t():e.persistentwebsocket=t()}(this,function(){return function(e){function t(o){if(n[o])return n[o].exports;var i=n[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1)}([function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return Math.floor(Math.random()*(t-e))+e}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),c=function(){function e(t,n){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i;o(this,e),this._initialDelay=t,this._maxDelay=n,this._nextDelay=this._initialDelay,this._randomBetween=s}return s(e,[{key:"reset",value:function(){this._nextDelay=this._initialDelay}},{key:"nextDelay",value:function(){var e=this._nextDelay;return this._nextDelay=Math.min(this._maxDelay,this._randomBetween(this._initialDelay,3*e)),e}}]),e}();t.default=c,e.exports=t.default},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(){}Object.defineProperty(t,"__esModule",{value:!0}),t.PersistentWebsocket=t.AttemptReconnectEvent=void 0;var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),u=n(0),a=o(u),l={debug:!1,initialBackoffDelayMillis:500,maxBackoffDelayMillis:9e4,pingSendFunction:null,pingIntervalSeconds:30,pingTimeoutMillis:2e3,connectTimeoutMillis:3e3},h=t.AttemptReconnectEvent=function e(t,n){i(this,e),this.attemptNumber=t,this.waitMillis=n};t.PersistentWebsocket=function(){function e(t,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};i(this,e),"object"===("undefined"==typeof n?"undefined":c(n))&&(o=n,n=void 0),this.onopen=s,this.onclose=s,this.onmessage=s,this.onerror=s,this.onbeforereconnect=s,this._url=t,this._protocols=n,this._options=Object.assign({},l,o),this._backoff=new a.default(this._options.initialBackoffDelayMillis,this._options.maxBackoffDelayMillis),this._waitingForPong=!1,this._manuallyClosed=!1,this._hasConnected=!1,this._retryCount=0,this._pingIntervalId=0,this._scheduledReconnectTimeoutId=0,this._websocketConnectionCheckTimeoutId=0}return r(e,[{key:"_createWebsocket",value:function(e,t){return new WebSocket(e,t)}},{key:"_openWebsocket",value:function(){this._debugLog("Trying to open websocket");var e=this._createWebsocket(this._url,this._protocols);this._binaryType&&(e.binaryType=this._binaryType),e.onclose=this._onWebsocketClose.bind(this),e.onerror=this._onWebsocketError.bind(this),e.onmessage=this._onWebsocketMessage.bind(this),e.onopen=this._onWebsocketOpen.bind(this),this._websocket=e,this._scheduleWebsocketConnectionCheck()}},{key:"_onWebsocketClose",value:function(e){e.wasExpected=this._manuallyClosed,this.onclose(e),this._manuallyClosed||this._scheduleReconnect()}},{key:"_onWebsocketError",value:function(e){this.onerror(e)}},{key:"_onWebsocketMessage",value:function(e){this._waitingForPong=!1,this.onmessage(e)}},{key:"_onWebsocketOpen",value:function(e){var t=this._options,n=t.pingSendFunction,o=t.pingIntervalSeconds;n&&o&&(this._pingIntervalId=setInterval(this._sendPing,this._options.pingIntervalSeconds,this)),e.wasReconnect=this._hasConnected,this.onopen(e),this._hasConnected=!0,this._retryCount=0,e.target.readyState==WebSocket.OPEN&&this._cancelWebsocketConnectionCheck()}},{key:"_sendPing",value:function(e){e._waitingForPong=!0,e._options.pingSendFunction(e),setTimeout(e._checkPingResult,e._options.pingTimeoutMillis,e)}},{key:"_checkPingResult",value:function(e){e._waitingForPong&&(clearInterval(e._pingIntervalId),e._pingIntervalId=0,e._websocket.close(4001,"Closing websocket due to ping failure."))}},{key:"_scheduleReconnect",value:function(){var e=this._backoff.nextDelay();this._retryCount++,this._debugLog("Scheduling websocket reconnect attempt "+this._retryCount+" in "+e+"ms"),this.onbeforereconnect(new h(this._retryCount,e)),this._scheduledReconnectTimeoutId=setTimeout(this._openWebsocket.bind(this),e)}},{key:"_cancelScheduledReconnect",value:function(){this._scheduledReconnectTimeoutId&&(clearTimeout(this._scheduledReconnectTimeoutId),this._scheduledReconnectTimeoutId=0)}},{key:"_scheduleWebsocketConnectionCheck",value:function(){setTimeout(this._checkWebsocketConnection.bind(this),this._options.connectTimeoutMillis)}},{key:"_cancelWebsocketConnectionCheck",value:function(){this._websocketConnectionCheckTimeoutId&&(clearTimeout(this._websocketConnectionCheckTimeoutId),this._websocketConnectionCheckTimeoutId=0)}},{key:"_checkWebsocketConnection",value:function(){this._debugLog("Checking websocket connection. ReadyState is "+this._websocket.readyState),this._websocket.readyState!=WebSocket.OPEN&&this._websocket.close(4e3,"Unable to establish websocket connection before the configured connectTimeoutMillis")}},{key:"_debugLog",value:function(e){this._options.debug&&console.debug(e)}},{key:"open",value:function(){if(this._websocket)throw"Websocket has already been opened";this._openWebsocket()}},{key:"close",value:function(e,t){if(this._manuallyClosed=!0,this._cancelScheduledReconnect(),this._cancelWebsocketConnectionCheck(),!this._websocket)throw"Can't close websocket because it was never opened.";this._websocket.close(e,t)}},{key:"send",value:function(e){if(!this._websocket)throw"Can't send through websocket because it was never opened.";this._websocket.send(e)}},{key:"readyState",get:function(){if(!this._websocket)throw"Can't get websocket readyState because it was never opened.";return this._websocket.readyState}},{key:"url",get:function(){return this._url}},{key:"bufferedAmount",get:function(){if(!this._websocket)throw"Can't get websocket bufferedAmount because it was never opened.";return this._websocket.bufferedAmount}},{key:"extensions",get:function(){if(!this._websocket)throw"Can't get websocket extensions because it was never opened.";return this._websocket.extensions}},{key:"binaryType",get:function(){return this._binaryType},set:function(e){this._binaryType=e,this._websocket&&(this._websocket.binaryType=e)}},{key:"retryCount",get:function(){return this._retryCount}}]),e}()}])});